<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pump Stations Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Leaflet & Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <style>
    body { margin:0; padding:0; font-family:sans-serif; }
    #map { height:60vh; }
    #stationsTable { height:40vh; overflow-y:auto; }
    #stationsTable table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ccc; padding:6px; }
    th { background:#f5f5f5; }
    tr { cursor:pointer; }
    tr:hover { background:#fafafa; }
    tr.selected { background:#d0e7ff !important; }
    input { width:100%; box-sizing:border-box; }
    button { margin:0 4px; }
  </style>
</head>
<body>

  <h1 style="margin:10px">Pump Stations Admin</h1>
  <div id="map"></div>

  <div id="stationsTable">
    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Address</th>
          <th>Lat</th>
          <th>Lon</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Leaflet, Geocoder & Firebase SDKs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <script>
  (async function(){
    // ─── Firebase init ────────────────────────────────────────────────
    firebase.initializeApp({
      apiKey:            "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
      authDomain:        "sd3ps-map.firebaseapp.com",
      projectId:         "sd3ps-map",
      storageBucket:     "sd3ps-map.appspot.com",
      messagingSenderId: "14976888367",
      appId:             "1:14976888367:web:9ef05a76be1ca780d7e0da",
      measurementId:     "G-HHX1X8KFSF"
    });
    const analytics = firebase.analytics();
    const db        = firebase.firestore();

    // ─── Map + search ─────────────────────────────────────────────────
    const map = L.map('map').setView([40.730889, -73.284654], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap contributors'
    }).addTo(map);
    L.Control.geocoder({ placeholder: 'Search address…' })
      .on('markgeocode', e => map.setView(e.geocode.center, 17))
      .addTo(map);

    // ─── Data structures ───────────────────────────────────────────────
    const markers = [], docs = [];
    const tbody   = document.querySelector('#stationsTable tbody');
    const tempDel = {}; // for undo-delete-note

    // ─── Build one station row + marker ───────────────────────────────
    async function addStation(doc, idx){
      const code    = doc.id;
      const { address, lat, lon } = doc.data();
      docs[idx] = doc;

      // 1) TABLE ROW
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="code" value="${code}" readonly></td>
        <td><input class="addr" value="${address}" readonly></td>
        <td><input class="lat"  type="number" step="any" value="${lat}" readonly></td>
        <td><input class="lon"  type="number" step="any" value="${lon}" readonly></td>
        <td>
          <button class="edit" data-idx="${idx}">Edit</button>
          <button class="del"  data-idx="${idx}">Delete</button>
        </td>`;
      tbody.appendChild(tr);

      // clicking row highlights + opens popup
      tr.addEventListener('click', () => {
        document.querySelectorAll('#stationsTable tr')
          .forEach(r=>r.classList.remove('selected'));
        tr.classList.add('selected');
        markers[idx].fire('click');
      });

      // 2) MAP MARKER
      const m = L.marker([lat, lon]).addTo(map);
      markers[idx] = m;
      m.on('click', async () => {
        const noteSnap = await db.collection('notes').doc(code).get();
        const note     = noteSnap.exists ? noteSnap.data().text : '';
        const popup = `
          <strong>${code}</strong><br>
          ${address}<br>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}"
             target="_blank">Navigate</a>
          | <a href="#" class="note-btn"    data-idx="${idx}">Add/Edit Note</a>
          | <a href="#" class="del-note"    data-idx="${idx}">Delete Note</a>
          | <a href="#" class="undo-note"   data-idx="${idx}" style="display:none">Undo</a>
          | <a href="#" class="adjust-pin"  data-idx="${idx}">Adjust Pin</a>
          <br>
          <div id="note-display-${idx}"
               style="margin-top:6px;font-style:italic;color:#555;">
            ${note}
          </div>`;
        map.once('moveend', () => m.bindPopup(popup).openPopup());
        map.setView([lat, lon], 17, { animate:true, duration:0.8 });
      });
    }

    // ─── Load & render all stations ────────────────────────────────────
    const snap = await db.collection('pumpStations').get();
    snap.docs.forEach((doc,i) => addStation(doc,i));

    // ─── Table Edit/Delete handling ───────────────────────────────────
    tbody.addEventListener('click', async e => {
      const idx = +e.target.dataset.idx;
      if (e.target.matches('.edit')){
        const tr = tbody.children[idx];
        // toggle readonly → editable
        const inputs = tr.querySelectorAll('input');
        const isEditing = inputs[0].readOnly;
        inputs.forEach(i=> i.readOnly = !isEditing);
        e.target.textContent = isEditing ? 'Save' : 'Edit';
        if (!isEditing) {
          // just switched from editing→save: persist
          const code = tr.querySelector('.code').value;
          const newAddress = tr.querySelector('.addr').value.trim();
          const newLat     = parseFloat(tr.querySelector('.lat').value);
          const newLon     = parseFloat(tr.querySelector('.lon').value);
          await db.collection('pumpStations').doc(code)
                  .update({ address:newAddress, lat:newLat, lon:newLon });
          alert('Station saved');
        }
      }
      if (e.target.matches('.del')){
        const code = tbody.children[idx].querySelector('.code').value;
        if (!confirm(`Delete station "${code}"?`)) return;
        await db.collection('pumpStations').doc(code).delete();
        alert('Deleted');
        location.reload();
      }
    });

    // ─── Popup note & pin adjustment handling ─────────────────────────
    document.body.addEventListener('click', async e => {
      const idx = +e.target.dataset.idx;
      if (isNaN(idx)) return;
      const code = docs[idx].id;

      // Add/Edit note
      if (e.target.matches('.note-btn')){
        e.preventDefault();
        const cur = (await db.collection('notes').doc(code).get()).data()?.text||'';
        const txt = prompt(`Note for ${code}:`, cur);
        if (txt!==null){
          await db.collection('notes').doc(code)
            .set({ text:txt, updated:firebase.firestore.FieldValue.serverTimestamp() });
          document.getElementById(`note-display-${idx}`).textContent = txt;
        }
      }
      // Delete note
      if (e.target.matches('.del-note')){
        e.preventDefault();
        const nsnap = await db.collection('notes').doc(code).get();
        tempDel[code] = nsnap.exists ? nsnap.data().text : '';
        await db.collection('notes').doc(code).delete();
        document.getElementById(`note-display-${idx}`).textContent = '';
        e.target.nextElementSibling.style.display = 'inline';
      }
      // Undo note
      if (e.target.matches('.undo-note')){
        e.preventDefault();
        await db.collection('notes').doc(code)
          .set({ text:tempDel[code], updated:firebase.firestore.FieldValue.serverTimestamp() });
        document.getElementById(`note-display-${idx}`).textContent = tempDel[code];
        e.target.style.display = 'none';
      }
      // Adjust pin
      if (e.target.matches('.adjust-pin')){
        e.preventDefault();
        const m = markers[idx];
        if (!m.dragging.enabled()){
          m.dragging.enable();
          e.target.textContent = 'Save Pin';
        } else {
          m.dragging.disable();
          const {lat,lng} = m.getLatLng();
          await db.collection('pumpStations').doc(code)
            .update({ lat, lon:lng });
          alert('Pin moved');
          location.reload();
        }
      }
    });
  })();
  </script>
</body>
</html>
