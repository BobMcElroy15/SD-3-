<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pump Stations Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Leaflet & Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <style>
    body { margin:0; padding:0; font-family:sans-serif; }
    #map { height:50vh; }
    #stationsTable { height:50vh; overflow-y:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ccc; padding:6px; text-align:left }
    th { background:#f5f5f5; }
    tr:hover { background:#fafafa; }
    input.inline { width:100%; box-sizing:border-box; border:none; background:transparent; }
    input.inline:disabled { color: #333; }
    button { margin:0 4px; }
  </style>
</head>
<body>

  <h1 style="margin:10px">Pump Stations Admin</h1>
  <div id="map"></div>

  <div id="stationsTable">
    <table>
      <thead>
        <tr>
          <th>Code</th><th>Address</th><th>Lat</th><th>Lon</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Leaflet, Geocoder & Firebase SDKs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <script>
  (async function(){
    // ─── Firebase init ───────────────────────────────────────────────
    firebase.initializeApp({
      apiKey:    "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
      authDomain:"sd3ps-map.firebaseapp.com",
      projectId: "sd3ps-map",
      storageBucket:"sd3ps-map.appspot.com",
      messagingSenderId:"14976888367",
      appId:     "1:14976888367:web:9ef05a76be1ca780d7e0da",
      measurementId:"G-HHX1X8KFSF"
    });
    const db = firebase.firestore();

    // ─── Map + search ────────────────────────────────────────────────
    const map = L.map('map').setView([40.730889, -73.284654], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OSM' }).addTo(map);
    L.Control.geocoder().addTo(map);

    // ─── Data structures ─────────────────────────────────────────────
    const tbody = document.querySelector('tbody');
    const markers = [], docs = [];
    const tempDel = {};

    // ─── Render a station row & marker ───────────────────────────────
    function addStation(doc,i){
      const { address, lat, lon } = doc.data();
      const code = doc.id;
      docs[i] = doc;

      // -- Table row
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="inline code" value="${code}" disabled></td>
        <td><input class="inline addr" value="${address}" disabled></td>
        <td><input class="inline lat" type="number" step="any" value="${lat}" disabled></td>
        <td><input class="inline lon" type="number" step="any" value="${lon}" disabled></td>
        <td>
          <button class="edit" data-idx="${i}">Edit</button>
          <button class="save" data-idx="${i}" style="display:none">Save</button>
          <button class="cancel" data-idx="${i}" style="display:none">Cancel</button>
          <button class="del" data-idx="${i}">Delete</button>
        </td>`;
      tbody.appendChild(tr);

      // clicking row triggers marker popup
      tr.addEventListener('click',()=> markers[i].fire('click'));

      // -- Leaflet marker
      const m = L.marker([lat,lon]).addTo(map);
      markers[i] = m;

      m.on('click', async ()=>{
        const noteSnap = await db.collection('notes').doc(code).get();
        const note = noteSnap.exists? noteSnap.data().text : '';
        const html = `
          <strong>${code}</strong><br>${address}<br>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank">Navigate</a>
          | <a href="#" class="note-btn" data-idx="${i}">Add/Edit Note</a>
          | <a href="#" class="delete-note-btn" data-idx="${i}">Delete Note</a>
          | <a href="#" class="undo-note-btn" data-idx="${i}" style="display:none">Undo</a>
          <br><div id="note-display-${i}" style="font-style:italic;color:#555">${note}</div>`;
        m.bindPopup(html).openPopup();
      });
    }

    // ─── Load & render all ────────────────────────────────────────────
    const snap = await db.collection('pumpStations').get();
    snap.docs.forEach((doc,i)=> addStation(doc,i));

    // ─── Table actions: Edit/Save/Cancel/Delete ───────────────────────
    tbody.addEventListener('click', async e=>{
      const idx = +e.target.dataset.idx;
      const tr = tbody.children[idx];
      const inputs = tr.querySelectorAll('input.inline');
      const [codeI, addrI, latI, lonI] = inputs;
      const code = codeI.value;

      // -- Edit: enable inputs
      if(e.target.matches('.edit')){
        inputs.forEach(i=>i.disabled=false);
        tr.querySelector('.edit').style.display='none';
        tr.querySelector('.del').style.display='none';
        tr.querySelector('.save').style.display='inline';
        tr.querySelector('.cancel').style.display='inline';
        return;
      }
      // -- Cancel: revert values & disable
      if(e.target.matches('.cancel')){
        const orig = docs[idx].data();
        addrI.value = orig.address;
        latI.value = orig.lat;
        lonI.value = orig.lon;
        inputs.forEach(i=>i.disabled=true);
        tr.querySelector('.edit').style.display='inline';
        tr.querySelector('.del').style.display='inline';
        tr.querySelector('.save').style.display='none';
        tr.querySelector('.cancel').style.display='none';
        return;
      }
      // -- Save: write back & disable
      if(e.target.matches('.save')){
        const newData = {
          address: addrI.value.trim(),
          lat: parseFloat(latI.value),
          lon: parseFloat(lonI.value)
        };
        await db.collection('pumpStations').doc(code).update(newData);
        alert('Saved');
        inputs.forEach(i=>i.disabled=true);
        tr.querySelector('.edit').style.display='inline';
        tr.querySelector('.del').style.display='inline';
        tr.querySelector('.save').style.display='none';
        tr.querySelector('.cancel').style.display='none';
        return;
      }
      // -- Delete row
      if(e.target.matches('.del')){
        if(confirm(`Delete station "${code}"?`)){
          await db.collection('pumpStations').doc(code).delete();
          location.reload();
        }
      }
    });

    // ─── Notes CRUD in popup ──────────────────────────────────────────
    document.body.addEventListener('click', async e=>{
      if(!e.target.dataset.idx) return;
      const i = +e.target.dataset.idx;
      const code = docs[i].id;

      if(e.target.matches('.note-btn')){
        e.preventDefault();
        const cur = (await db.collection('notes').doc(code).get()).data()?.text||'';
        const txt = prompt(`Note for ${code}:`, cur);
        if(txt!==null){
          await db.collection('notes').doc(code).set({
            text:txt,
            updated:firebase.firestore.FieldValue.serverTimestamp()
          });
          document.getElementById(`note-display-${i}`).textContent = txt;
        }
      }
      if(e.target.matches('.delete-note-btn')){
        e.preventDefault();
        const snapN = await db.collection('notes').doc(code).get();
        tempDel[code] = snapN.exists? snapN.data().text:'';
        await db.collection('notes').doc(code).delete();
        document.getElementById(`note-display-${i}`).textContent = '';
        e.target.nextElementSibling.style.display='inline';
      }
      if(e.target.matches('.undo-note-btn')){
        e.preventDefault();
        await db.collection('notes').doc(code).set({
          text:tempDel[code],
          updated:firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById(`note-display-${i}`).textContent = tempDel[code];
        e.target.style.display='none';
        delete tempDel[code];
      }
    });

  })();
  </script>
</body>
</html>
