<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pump Stations Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Leaflet & Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <style>
    body { margin:0; padding:0; font-family:sans-serif; }
    h1 { margin:12px; }
    #map { height:50vh; }
    #stationsTable { height:50vh; overflow-y:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#f0f0f0; }
    tr { transition: background .15s ease; }
    tr:hover, tr.highlight { background:#d0eaff !important; }
    input { width:100%; box-sizing:border-box; padding:4px; border:1px solid #ccc; border-radius:4px; }
    button { margin:0 4px; padding:4px 8px; border:none; background:#0066cc; color:#fff; border-radius:4px; cursor:pointer; }
    button.cancel { background:#aaa; }
    button.save, button.cancel { display:none; }
  </style>
</head>
<body>

  <h1>Pump Stations Admin</h1>
  <div id="map"></div>

  <div id="stationsTable">
    <table>
      <thead>
        <tr><th>Code</th><th>Address</th><th>Lat</th><th>Lon</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- SDKs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <script>
  (async function(){
    // ─── Firebase init
    firebase.initializeApp({
      apiKey: "...", authDomain:"sd3ps-map.firebaseapp.com",
      projectId:"sd3ps-map", storageBucket:"sd3ps-map.appspot.com",
      messagingSenderId:"...", appId:"...", measurementId:"..."
    });
    const analytics = firebase.analytics();
    const db        = firebase.firestore();

    // ─── Map + Geocoder
    const map = L.map('map').setView([40.73,-73.28],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}).addTo(map);
    L.Control.geocoder({ geocoder:L.Control.Geocoder.nominatim(), placeholder:'Search address…' })
      .on('markgeocode', e=> map.setView(e.geocode.center,17))
      .addTo(map);

    // ─── Data holders
    const tbody   = document.querySelector('#stationsTable tbody');
    const markers = [], docs = [], tempDel={};

    // ─── openStationPopup (unchanged)
    async function openStationPopup(idx){
      const doc = docs[idx], code=doc.id, data=doc.data();
      // highlight row
      document.querySelectorAll('tr').forEach(r=>r.classList.remove('highlight'));
      const tr=tbody.children[idx];
      tr.scrollIntoView({behavior:'smooth',block:'nearest'});
      tr.classList.add('highlight');
      // fetch note
      const ns=await db.collection('notes').doc(code).get();
      const note=ns.exists?ns.data().text:'';
      // build popup HTML...
      const html = `
        <strong>${code}</strong><br>
        ${data.address}<br>
        <a href="https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lon}" target="_blank">Navigate</a>
        | <a href="#" class="note-btn" data-idx="${idx}">Note</a>
        | <a href="#" class="del-note" data-idx="${idx}">Del Note</a>
        | <a href="#" class="undo-note" data-idx="${idx}" style="display:none">Undo</a>
        | <a href="#" class="adjust-pin" data-idx="${idx}">Adjust Pin</a>
        <br><div id="note-display-${idx}" style="font-style:italic;color:#555">${note}</div>`;
      const m=markers[idx];
      map.once('moveend',()=>m.bindPopup(html).openPopup());
      map.setView([data.lat,data.lon],17,{animate:true});
    }

    // ─── Build each station row + marker
    const snap = await db.collection('pumpStations').get();
    snap.docs.forEach((doc,idx)=>{
      docs[idx]=doc;
      const code=doc.id, {address,lat,lon}=doc.data();

      // ROW
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="code" value="${code}" disabled></td>
        <td><input class="addr" value="${address}" disabled></td>
        <td><input class="lat"  type="number" step="any" value="${lat}" disabled></td>
        <td><input class="lon"  type="number" step="any" value="${lon}" disabled></td>
        <td>
          <button class="edit"  data-idx="${idx}">Edit</button>
          <button class="save"  data-idx="${idx}">Save</button>
          <button class="cancel"data-idx="${idx}">Cancel</button>
          <button class="del"   data-idx="${idx}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
      tr.addEventListener('click',()=>openStationPopup(idx));

      // MARKER
      const m=L.marker([lat,lon]).addTo(map);
      markers[idx]=m;
      m.on('click',()=>openStationPopup(idx));
    });

    // ─── Table controls: Edit / Save / Cancel / Delete
    tbody.addEventListener('click',async e=>{
      const idx=+e.target.dataset.idx, tr=tbody.children[idx];
      const code=tr.querySelector('.code').value;
      if(e.target.matches('.edit')){
        ['addr','lat','lon'].forEach(c=>tr.querySelector(`.${c}`).disabled=false);
        tr.querySelector('.edit').style.display='none';
        tr.querySelector('.save').style.display='';
        tr.querySelector('.cancel').style.display='';
      }
      if(e.target.matches('.cancel')) location.reload();
      if(e.target.matches('.save')){
        const a=tr.querySelector('.addr').value.trim(),
              la=parseFloat(tr.querySelector('.lat').value),
              lo=parseFloat(tr.querySelector('.lon').value);
        await db.collection('pumpStations').doc(code).update({address:a,lat:la,lon:lo});
        alert('Saved'); location.reload();
      }
      if(e.target.matches('.del')){
        if(!confirm(`Delete ${code}?`))return;
        await db.collection('pumpStations').doc(code).delete();
        alert('Deleted'); location.reload();
      }
    });

    // ─── Popup note & adjust-pin
    document.body.addEventListener('click',async e=>{
      const idx=+e.target.dataset.idx; if(isNaN(idx)) return;
      const code=docs[idx].id;
      if(e.target.matches('.note-btn')){
        e.preventDefault();
        const cur=(await db.collection('notes').doc(code).get()).data()?.text||'';
        const txt=prompt(`Note for ${code}:`,cur);
        if(txt!==null){
          await db.collection('notes').doc(code).set({text:txt,updated:firebase.firestore.FieldValue.serverTimestamp()});
          document.getElementById(`note-display-${idx}`).textContent=txt;
        }
      }
      if(e.target.matches('.del-note')){
        e.preventDefault();
        const sn=await db.collection('notes').doc(code).get();
        tempDel[code]=sn.exists?sn.data().text:'';
        await db.collection('notes').doc(code).delete();
        document.getElementById(`note-display-${idx}`).textContent='';
        e.target.nextElementSibling.style.display='inline';
      }
      if(e.target.matches('.undo-note')){
        e.preventDefault();
        await db.collection('notes').doc(code).set({text:tempDel[code],updated:firebase.firestore.FieldValue.serverTimestamp()});
        document.getElementById(`note-display-${idx}`).textContent=tempDel[code];
        e.target.style.display='none'; delete tempDel[code];
      }
      if(e.target.matches('.adjust-pin')){
        e.preventDefault();
        const m=markers[idx];
        if(!m.dragging.enabled()){
          m.dragging.enable();
          e.target.textContent='Save Pin';
        } else {
          m.dragging.disable();
          const {lat,lng}=m.getLatLng();
          if(!confirm('Save new pin location?')) {
            const old=docs[idx].data();
            return m.setLatLng([old.lat,old.lon]);
          }
          await db.collection('pumpStations').doc(code).update({lat,lng});
          alert('Pin moved'); location.reload();
        }
      }
    });

  })();
  </script>

</body>
</html>
