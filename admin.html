<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pump Stations Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <!-- Geocoder plugin CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
  />

  <style>
    body { margin:0; padding:0; font-family:sans-serif; }
    #map { height:60vh; }
    table { width:100%; border-collapse:collapse; }
    th,td { border:1px solid #ccc; padding:8px; }
    th { background:#f5f5f5; }
    tr:hover { background:#fafafa; cursor:pointer; }
    #stationsTable { height:40vh; overflow-y:auto; display:block; }
    #stationsTable table { width:100%; } 
  </style>
</head>
<body>

  <h1 style="margin:10px">Pump Stations Admin</h1>
  <div id="map"></div>

  <div id="stationsTable">
    <table>
      <thead>
        <tr>
          <th>Code</th><th>Address</th><th>Lat</th><th>Lon</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Leaflet & Geocoder & Firebase SDKs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <script>
  // ─── Firebase init ─────────────────────────────────────────────────
  firebase.initializeApp({
    apiKey:            "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
    authDomain:        "sd3ps-map.firebaseapp.com",
    projectId:         "sd3ps-map",
    storageBucket:     "sd3ps-map.appspot.com",
    messagingSenderId: "14976888367",
    appId:             "1:14976888367:web:9ef05a76be1ca780d7e0da",
    measurementId:     "G-HHX1X8KFSF"
  });
  const analytics = firebase.analytics();
  const db        = firebase.firestore();

  // ─── Map + Geocoder ────────────────────────────────────────────────
  const map = L.map('map').setView([40.730889, -73.284654], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap contributors'
  }).addTo(map);
  L.Control.geocoder({ placeholder: 'Search address…' })
    .on('markgeocode', e => {
      map.setView(e.geocode.center, 17);
    }).addTo(map);

  // ─── Data structures ───────────────────────────────────────────────
  const markers = [], docs = [];
  const tableBody = document.querySelector('#stationsTable tbody');
  const tempDel = {}; // for undo-delete-note

  // ─── Build one station row + marker ─────────────────────────────────
  async function addStation(doc, i) {
    const { address, lat, lon } = doc.data();
    const code = doc.id;
    docs[i] = doc;

    // 1) TABLE ROW
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${code}</td>
      <td>${address}</td>
      <td>${lat}</td>
      <td>${lon}</td>
      <td>
        <button class="edit-row" data-idx="${i}">Save</button>
        <button class="delete-row" data-idx="${i}">Del</button>
      </td>`;
    tableBody.appendChild(tr);
    tr.addEventListener('click', () => markers[i].fire('click'));

    // 2) MAP MARKER
    const m = L.marker([lat, lon], { draggable: false }).addTo(map);
    markers[i] = m;

    // popup builder
    async function openPopup() {
      const snap = await db.collection('notes').doc(code).get();
      const note = snap.exists ? snap.data().text : '';
      const html = `
        <strong>${code}</strong><br>
        ${address}<br>
        <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}"
           target="_blank">Navigate</a>
        | <a href="#" class="note-btn" data-idx="${i}">Add/Edit Note</a>
        | <a href="#" class="delete-note-btn" data-idx="${i}">Delete Note</a>
        | <a href="#" class="undo-note-btn" data-idx="${i}" style="display:none">Undo Delete</a>
        | <a href="#" class="adjust-pin-btn" data-idx="${i}">Adjust Pin</a>
        <br>
        <div id="note-display-${i}" style="margin-top:6px;font-style:italic;color:#555;">
          ${note}
        </div>
      `;
      map.once('moveend', () => m.setPopupContent(html).openPopup());
      map.setView([lat, lon], 17, { animate:true, duration:0.8 });
    }

    m.on('click', openPopup);
  }

  // ─── Load & render all stations ────────────────────────────────────
  const snap = await db.collection('pumpStations').get();
  snap.docs.forEach((doc, i) => addStation(doc, i));

  // ─── Delegate table edits/deletes ─────────────────────────────────
  tableBody.addEventListener('click', async e => {
    if (e.target.matches('.edit-row')) {
      const i = +e.target.dataset.idx;
      const tr = tableBody.children[i];
      const [codeCell, addressCell, latCell, lonCell] = tr.children;
      const code = codeCell.textContent.trim();
      const newAddress = addressCell.textContent.trim();
      const newLat = parseFloat(latCell.textContent);
      const newLon = parseFloat(lonCell.textContent);
      await db.collection('pumpStations').doc(code).update({
        address:newAddress, lat:newLat, lon:newLon
      });
      alert('Station updated');
      location.reload();
    }
    if (e.target.matches('.delete-row')) {
      const i = +e.target.dataset.idx;
      const code = tableBody.children[i].children[0].textContent.trim();
      if (confirm(`Delete station ${code}?`)) {
        await db.collection('pumpStations').doc(code).delete();
        alert('Deleted');
        location.reload();
      }
    }
  });

  // ─── Delegate all popup clicks (notes, pin adjust) ────────────────
  document.body.addEventListener('click', async e => {
    const sel = e.target;
    if (!sel.dataset.idx) return;
    const i = +sel.dataset.idx;
    const doc = docs[i];  
    const code = doc.id;

    // Add/Edit Note
    if (sel.matches('.note-btn')) {
      e.preventDefault();
      analytics.logEvent('edit_note',{station:code});
      const cur = (await db.collection('notes').doc(code).get()).data()?.text||'';
      const txt = prompt(`Note for ${code}:`,cur);
      if (txt!==null) {
        await db.collection('notes').doc(code).set({
          text:txt,
          updated:firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById(`note-display-${i}`).textContent = txt;
      }
    }

    // Delete Note
    if (sel.matches('.delete-note-btn')) {
      e.preventDefault();
      analytics.logEvent('delete_note',{station:code});
      const snapN = await db.collection('notes').doc(code).get();
      tempDel[code] = snapN.exists? snapN.data().text : '';
      await db.collection('notes').doc(code).delete();
      document.getElementById(`note-display-${i}`).textContent = '';
      sel.closest('div')
         .querySelector(`.undo-note-btn[data-idx="${i}"]`)
         .style.display = 'inline';
    }

    // Undo Delete
    if (sel.matches('.undo-note-btn')) {
      e.preventDefault();
      analytics.logEvent('undo_delete_note',{station:code});
      await db.collection('notes').doc(code).set({
        text:tempDel[code],
        updated:firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById(`note-display-${i}`).textContent = tempDel[code];
      sel.style.display='none';
      delete tempDel[code];
    }

    // Adjust Pin
    if (sel.matches('.adjust-pin-btn')) {
      e.preventDefault();
      analytics.logEvent('adjust_pin',{station:code});
      const m = markers[i];
      if (!m.dragging.enabled()) {
        m.dragging.enable();
        sel.textContent = 'Save Pin';
      } else {
        m.dragging.disable();
        const {lat,lng} = m.getLatLng();
        await db.collection('pumpStations').doc(code).update({
          lat, lon:lng
        });
        alert('Pin moved');
        location.reload();
      }
    }
  });
  </script>
</body>
</html>
