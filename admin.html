<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin – Pump Stations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Leaflet & Geocoder CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
  />

  <style>
    body { font-family:sans-serif; margin:20px; }
    h1 { margin-bottom:10px; }
    form { margin-bottom:10px; }
    input { margin-right:8px; }
    #adminMap { height:300px; margin-bottom:20px; border:1px solid #ccc; }
    table { border-collapse:collapse; width:100%; }
    th,td { border:1px solid #ccc; padding:8px; }
    th { background:#f5f5f5; }
    button { margin-right:8px; }
  </style>
</head>
<body>
  <h1>Pump Stations Admin</h1>

  <form id="addForm">
    <input type="text"   id="newCode"    placeholder="Code (e.g. PS#315)" required>
    <input type="text"   id="newAddress" placeholder="Address" required>
    <input type="number" id="newLat"     placeholder="Latitude" step="any" required>
    <input type="number" id="newLon"     placeholder="Longitude" step="any" required>
    <button type="submit">Add Station</button>
  </form>

  <!-- map for search & new-station pin -->
  <div id="adminMap"></div>

  <table id="stationsTable">
    <thead>
      <tr>
        <th>Code</th><th>Address</th><th>Latitude</th><th>Longitude</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Leaflet & Geocoder JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // ─── Firebase init ────────────────────────────────────────────────
    firebase.initializeApp({
      apiKey:            "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
      authDomain:        "sd3ps-map.firebaseapp.com",
      projectId:         "sd3ps-map",
      storageBucket:     "sd3ps-map.appspot.com",
      messagingSenderId: "14976888367",
      appId:             "1:14976888367:web:9ef05a76be1ca780d7e0da",
      measurementId:     "G-HHX1X8KFSF"
    });
    const db  = firebase.firestore();
    const col = db.collection('pumpStations');

    const newCode    = document.getElementById('newCode');
    const newAddress = document.getElementById('newAddress');
    const newLat     = document.getElementById('newLat');
    const newLon     = document.getElementById('newLon');
    const addForm    = document.getElementById('addForm');
    const tbody      = document.querySelector('#stationsTable tbody');

    // ─── Leaflet map + geocoder ───────────────────────────────────────
    const adminMap = L.map('adminMap').setView([40.73, -73.28], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap contributors'
    }).addTo(adminMap);

    let adminMarker = null,
        editTarget  = null;

    // place a draggable marker; if targetRow supplied, sync drag→row
    function placeAdminMarker(lat, lng, targetRow = null) {
      if (adminMarker) adminMap.removeLayer(adminMarker);
      adminMarker = L.marker([lat, lng], { draggable:true }).addTo(adminMap);
      adminMap.setView([lat, lng], 17);
      editTarget = targetRow;
      adminMarker.on('dragend', e => {
        const p = e.target.getLatLng();
        if (editTarget) {
          const inputs = editTarget.querySelectorAll('input');
          inputs[2].value = p.lat.toFixed(6);
          inputs[3].value = p.lng.toFixed(6);
        } else {
          newLat.value = p.lat.toFixed(6);
          newLon.value = p.lng.toFixed(6);
        }
      });
    }

    // add-address geocoder
    L.Control.geocoder({ defaultMarkGeocode:false })
      .on('markgeocode', e=>{
        const c = e.geocode.center;
        newAddress.value = e.geocode.name;
        newLat.value     = c.lat.toFixed(6);
        newLon.value     = c.lng.toFixed(6);
        placeAdminMarker(c.lat, c.lng);
      })
      .addTo(adminMap);

    // ─── Render station rows ──────────────────────────────────────────
    function renderRow(doc) {
      const tr = document.createElement('tr');
      tr.dataset.id = doc.id;

      tr.innerHTML = `
        <td><input value="${doc.id}" /></td>
        <td><input value="${doc.data().address}" /></td>
        <td><input value="${doc.data().lat}"  type="number" step="any" /></td>
        <td><input value="${doc.data().lon}"  type="number" step="any" /></td>
        <td>
          <button class="save">Save</button>
          <button class="delete">Delete</button>
          <button class="editMap">Edit on Map</button>
        </td>
      `;

      // Save
      tr.querySelector('.save').onclick = async ()=>{
        const [c,a,lt,ln] = tr.querySelectorAll('input');
        const newC = c.value.trim(),
              newA = a.value.trim(),
              newL = parseFloat(lt.value),
              newG = parseFloat(ln.value);
        if (newC!==doc.id) {
          await col.doc(newC).set({ address:newA, lat:newL, lon:newG });
          await col.doc(doc.id).delete();
          tr.dataset.id = newC;
        } else {
          await col.doc(doc.id).update({ address:newA, lat:newL, lon:newG });
        }
        alert('Saved');
      };

      // Delete
      tr.querySelector('.delete').onclick = async ()=>{
        if (confirm(`Delete "${doc.id}"?`)) {
          await col.doc(doc.id).delete();
          tr.remove();
        }
      };

      // "Edit on Map"
      tr.querySelector('.editMap').onclick = () => {
        const inputs = tr.querySelectorAll('input');
        placeAdminMarker(
          parseFloat(inputs[2].value),
          parseFloat(inputs[3].value),
          tr
        );
      };

      tbody.appendChild(tr);
    }

    // ─── Load existing stations ────────────────────────────────────────
    col.get().then(snapshot=>{
      snapshot.forEach(doc=> renderRow(doc) );
    });

    // ─── Add new station handler ──────────────────────────────────────
    addForm.onsubmit = async e=>{
      e.preventDefault();
      const code = newCode.value.trim();
      if(!code) return alert('Code required');
      await col.doc(code).set({
        address: newAddress.value,
        lat:     parseFloat(newLat.value),
        lon:     parseFloat(newLon.value)
      });
      const d = await col.doc(code).get();
      renderRow(d);
      addForm.reset();
      if(adminMarker) adminMap.removeLayer(adminMarker);
    };
  </script>
</body>
</html>
