<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin – Pump Stations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body { font-family: sans-serif; margin:20px; }
    h1   { margin-bottom:10px; }

    /* Admin map */
    #adminMap { height:400px; margin-bottom:20px; }

    /* Table */
    table { border-collapse: collapse; width:100%; }
    th, td { border:1px solid #ccc; padding:8px; }
    th      { background:#f5f5f5; }
    .selected { background:#ffffcc; }

    input  { width:100%; box-sizing:border-box; }
    button { margin-right:8px; }
    #addForm input { width:auto; margin-right:8px; }
  </style>
</head>
<body>
  <h1>Pump Stations Admin</h1>

  <!-- interactive admin map -->
  <div id="adminMap"></div>

  <form id="addForm">
    <input type="text"    id="newCode"    placeholder="Code (e.g. PS#315)" required>
    <input type="text"    id="newAddress" placeholder="Address"         required>
    <input type="number"  id="newLat"     placeholder="Latitude"        step="any" required>
    <input type="number"  id="newLon"     placeholder="Longitude"       step="any" required>
    <button type="submit">Add Station</button>
  </form>

  <table id="stationsTable">
    <thead>
      <tr>
        <th>Code</th><th>Address</th><th>Latitude</th><th>Longitude</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Leaflet & Firebase JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ─── Firebase init ───────────────────────────────────────────────
    firebase.initializeApp({
      apiKey:            "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
      authDomain:        "sd3ps-map.firebaseapp.com",
      projectId:         "sd3ps-map",
      storageBucket:     "sd3ps-map.appspot.com",
      messagingSenderId: "14976888367",
      appId:             "1:14976888367:web:9ef05a76be1ca780d7e0da",
      measurementId:     "G-HHX1X8KFSF"
    });
    const db  = firebase.firestore();
    const col = db.collection('pumpStations');

    const tableBody = document.querySelector('#stationsTable tbody');
    const addForm   = document.getElementById('addForm');

    // ─── Admin Leaflet map ────────────────────────────────────────────
    const map     = L.map('adminMap').setView([40.73, -73.28], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap contributors'
    }).addTo(map);

    // keep track of markers by station code
    const markers = {};

    // ─── Render a table row, return the <tr>
    function renderRow(doc) {
      const code    = doc.id;
      const data    = doc.data();
      const tr      = document.createElement('tr');
      tr.dataset.id = code;

      tr.innerHTML = `
        <td><input value="${code}" /></td>
        <td><input value="${data.address}" /></td>
        <td><input value="${data.lat}"  type="number" step="any" /></td>
        <td><input value="${data.lon}"  type="number" step="any" /></td>
        <td>
          <button class="save">Save</button>
          <button class="delete">Delete</button>
        </td>
      `;

      // Save edits
      tr.querySelector('.save').onclick = async () => {
        const [inCode, inAddr, inLat, inLon] = tr.querySelectorAll('input');
        const newCode = inCode.value.trim(),
              newAddr = inAddr.value.trim(),
              newLat  = parseFloat(inLat.value),
              newLon  = parseFloat(inLon.value);
        if (!newCode) return alert('Code required');

        if (newCode !== code) {
          // copy under new key + remove old
          await col.doc(newCode).set({ address:newAddr, lat:newLat, lon:newLon });
          await col.doc(code).delete();
          // reassign marker reference
          markers[newCode] = markers[code];
          delete markers[code];
          tr.dataset.id = newCode;
        } else {
          await col.doc(code).update({ address:newAddr, lat:newLat, lon:newLon });
        }
        alert('Saved');
      };

      // Delete station
      tr.querySelector('.delete').onclick = async () => {
        if (confirm(`Delete station "${code}"?`)) {
          await col.doc(code).delete();
          tr.remove();
          map.removeLayer(markers[code]);
        }
      };

      tableBody.appendChild(tr);
      return tr;
    }

    // ─── Load all stations, build map + table ─────────────────────────
    async function init() {
      tableBody.innerHTML = '';
      // remove old markers
      Object.values(markers).forEach(m=>map.removeLayer(m));

      const snap = await col.get();
      snap.docs.forEach(doc => {
        const row = renderRow(doc);
        const { address, lat, lon } = doc.data();

        // place a draggable marker
        const marker = L.marker([lat, lon], { draggable:true })
          .addTo(map)
          .bindPopup(`<strong>${doc.id}</strong><br>${address}`);

        // clicking marker highlights & scrolls its row
        marker.on('click', () => {
          document.querySelectorAll('#stationsTable tr')
            .forEach(r=>r.classList.remove('selected'));
          row.classList.add('selected');
          row.scrollIntoView({ block:'center' });
        });

        // dragging marker updates Firestore & table inputs
        marker.on('dragend', async e => {
          const { lat:newLat, lng:newLon } = e.target.getLatLng();
          await col.doc(doc.id).update({ lat:newLat, lon:newLon });
          const inputs = row.querySelectorAll('td input');
          inputs[2].value = newLat;
          inputs[3].value = newLon;
        });

        // clicking the **table row** will fire that marker’s click event
        row.addEventListener('click', e => {
          // ignore clicks on the Save/Delete buttons
          if (e.target.tagName === 'BUTTON') return;
          marker.fire('click');
          marker.openPopup();
        });

        markers[doc.id] = marker;
      });
    }

    // ─── Add‐station form ─────────────────────────────────────────────
    addForm.onsubmit = async e => {
      e.preventDefault();
      const code    = document.getElementById('newCode').value.trim();
      const address = document.getElementById('newAddress').value.trim();
      const lat     = parseFloat(document.getElementById('newLat').value);
      const lon     = parseFloat(document.getElementById('newLon').value);
      if (!code) return alert('Code required');

      await col.doc(code).set({ address, lat, lon });
      init();
      addForm.reset();
    };

    // ─── Kick it off ─────────────────────────────────────────────────
    init();
  </script>
</body>
</html>
