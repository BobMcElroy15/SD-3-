<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin - Sewer District 3 Pump Station Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    :root {
      --primary-color: #0066cc;
      --light-primary: #e7f3ff;
      --danger-color: #dc3545;
      --success-color: #28a745;
      --light-gray: #f8f9fa;
      --border-color: #dee2e6;
      --text-color: #212529;
      --muted-color: #6c757d;
    }

    /* Base & Layout */
    body { 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0; 
      background-color: var(--light-gray);
      overflow: hidden;
    }

    /* Responsive Layout */
    /* Mobile First (Default) */
    #app-layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #map-container {
      height: 70vh;
      position: relative;
    }
    
    #side-panel {
      flex-grow: 1;
      background-color: #ffffff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Desktop Layout */
    @media (min-width: 992px) {
      #app-layout {
        flex-direction: row;
      }
      #map-container {
        order: 2;
        height: 100vh;
        flex-grow: 1;
      }
      #side-panel {
        order: 1;
        width: 420px;
        flex-grow: 0;
        border-right: 1px solid var(--border-color);
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
      }
    }
    
    #map { height: 100%; width: 100%; }

    /* Header */
    #panel-header { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    #panel-header h1 { font-size: 1.25rem; margin: 0; color: var(--text-color); }
    #logoutBtn { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); font-weight: 500; border-radius: 5px; padding: 0.4rem 0.8rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
    #logoutBtn:hover { background-color: var(--danger-color); color: white; }

    /* Scrollable Content Area */
    #panel-content { overflow-y: auto; padding: 1rem; flex-grow: 1;}
    #panel-content h2 { font-size: 1.1rem; margin-bottom: 0.75rem; }
    #addFromSearch { display: none; background: var(--light-primary); padding: 15px; border-radius: 8px; margin-bottom: 1rem; }
    #addFromSearch p { margin: 0 0 10px 0; font-weight: 500; }
    #addFromSearch button { background: var(--success-color); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1rem; }

    /* Station List */
    #stationList { list-style-type: none; padding: 0; margin: 0; }
    #stationList li { background: #fff; margin-bottom: 0.5rem; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; transition: box-shadow 0.2s, border-color 0.2s; }
    #stationList li:hover { border-color: var(--primary-color); }
    #stationList li.selected { border-color: var(--primary-color); background-color: var(--light-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    #stationList .info-line { font-weight: 500; margin-bottom: 0.25rem; display: flex; justify-content: space-between; align-items: center; }
    #stationList .coords-line { font-size: 0.8rem; color: var(--muted-color); }
    
    /* Streamlined Mobile List */
    @media (max-width: 991px) {
        #stationList .coords-line {
            display: none;
        }
        #stationList .note-text {
            display: none;
        }
        #stationList li {
            padding: 0.5rem 0.75rem;
        }
        .note-header {
            margin-bottom: 0;
        }
        .note-section {
            margin-top: 0.5rem;
            padding: 0.4rem 0.75rem;
        }
    }
    
    /* Note Section */
    .note-section { background: var(--light-gray); padding: 0.5rem 0.75rem; margin-top: 0.5rem; border-radius: 5px; }
    .note-text { font-style: italic; color: var(--muted-color); margin: 0; font-size: 0.9rem; word-wrap: break-word; }
    .note-text .no-note { color: #aaa; }
    .note-header { display: flex; justify-content: space-between; align-items: center; }
    .note-header span { font-weight: 500; font-size: 0.9rem; color: var(--muted-color); }

    /* Icon Button Styles */
    .icon-actions { display: flex; gap: 0.25rem; }
    .icon-btn { background: none; border: none; cursor: pointer; padding: 5px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
    .icon-btn:hover { background-color: var(--border-color); }
    .icon-btn svg { width: 16px; height: 16px; }
    .icon-btn.edit-btn svg { fill: var(--primary-color); }
    .icon-btn.delete-btn svg { fill: var(--danger-color); }
    .popup-link svg { width: 20px; height: 20px; }

    /* Auth Screen */
    #auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; background: #f8f9fa; }
    #auth-form { 
        background: white; 
        padding: 30px; 
        border-radius: 8px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        width: 320px;
        /* ** THE FIX IS HERE ** */
        position: relative;
        z-index: 10000;
    }
  </style>
</head>
<body>

  <div id="auth-container">
    <div id="auth-form">
      <h2 id="form-title">Admin Sign In</h2>
      <input type="email" id="emailInput" placeholder="Email"><input type="password" id="passwordInput" placeholder="Password"><div id="auth-error"></div><button id="authBtn">Sign In</button><a id="switch-form">Need an account? Sign Up</a>
    </div>
  </div>

  <div id="app-layout" style="display: none;">
    <main id="map-container">
      <div id="map"></div>
    </main>
    <aside id="side-panel">
      <header id="panel-header">
        <h1>Pump Station Management</h1>
        <button id="logoutBtn">Sign Out</button>
      </header>
      <div id="panel-content">
        <div id="addFromSearch">
            <p><strong>Add new station:</strong> <span id="searchedAddress"></span></p>
            <button id="addSearchedStationBtn">Add Searched Location</button>
        </div>
        <h2>Existing Stations</h2>
        <ul id="stationList"></ul>
      </div>
    </aside>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // --- App Setup & Firebase Init ---
    const firebaseConfig = {
      apiKey:            "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
      authDomain:        "sd3ps-map.firebaseapp.com",
      projectId:         "sd3ps-map",
      storageBucket:     "sd3ps-map.appspot.com",
      messagingSenderId: "14976888367",
      appId:             "1:14976888367:web:9ef05a76be1ca780d7e0da"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const authContainer = document.getElementById('auth-container');
    const appLayout = document.getElementById('app-layout');
    const logoutBtn = document.getElementById('logoutBtn');
    const stationList = document.getElementById('stationList');
    const addFromSearchUI = document.getElementById('addFromSearch');
    const searchedAddressSpan = document.getElementById('searchedAddress');
    const addSearchedStationBtn = document.getElementById('addSearchedStationBtn');
    let map;
    let markers = {};
    let lastSearchResult = null;
    let originalPinPositions = {};

    // --- Authentication Logic ---
    const authForm = document.getElementById('auth-form');
    const formTitle = document.getElementById('form-title');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const authBtn = document.getElementById('authBtn');
    const switchFormLink = document.getElementById('switch-form');
    const authError = document.getElementById('auth-error');
    let isSignUp = false;
    switchFormLink.addEventListener('click', () => {
        isSignUp = !isSignUp;
        formTitle.textContent = isSignUp ? 'Create Account' : 'Admin Sign In';
        authBtn.textContent = isSignUp ? 'Sign Up' : 'Sign In';
        switchFormLink.textContent = isSignUp ? 'Have an account? Sign In' : 'Need an account? Sign Up';
        authError.textContent = '';
    });
    authBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        authError.textContent = '';
        const authAction = isSignUp ? auth.createUserWithEmailAndPassword(email, password) : auth.signInWithEmailAndPassword(email, password);
        authAction.catch(error => { authError.textContent = error.message; });
    });
    logoutBtn.addEventListener('click', () => auth.signOut());
    auth.onAuthStateChanged(user => {
      if (user) {
        authContainer.style.display = 'none';
        appLayout.style.display = 'flex';
        initializeMap();
        getStations();
      } else {
        authContainer.style.display = 'flex';
        appLayout.style.display = 'none';
        if(map) { map.remove(); map = null; }
      }
    });

    // --- SVG Icons ---
    const icons = {
        edit: `<svg viewBox="0 0 24 24"><path d="M14.06,9.02l.92.92L5.92,19H5v-.92l9.06-9.06M17.66,3c-.25,0-.51.1-.7.29l-1.83,1.83,3.75,3.75,1.83-1.83c.39-.39.39-1.02,0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29m-3.6,3.19L3,17.25V21h3.75L17.81,9.94l-3.75-3.75Z"/></svg>`,
        delete: `<svg viewBox="0 0 24 24"><path d="M6,19c0,1.1.9,2,2,2h8c1.1,0,2-.9,2-2V7H6v12M8,9h8v10H8V9m7.5-5l-1-1h-5l-1,1H5v2h14V4h-3.5Z"/></svg>`,
        move: `<svg viewBox="0 0 24 24"><path d="M13,6V11h4.17l-4.59,4.59L8,11H12V6h1m7,6l-1.41,1.41L13,11.83V21h-2V11.83l-5.59,5.59L4,16l8-8,8,8Z"/></svg>`,
        save: `<svg viewBox="0 0 24 24"><path d="M9,16.17L4.83,12l-1.42,1.41L9,19,21,7l-1.41-1.41L9,16.17Z"/></svg>`,
        cancel: `<svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5,12,10.59,6.41,5,5,6.41,10.59,12,5,17.59,6.41,19,12,13.41,17.59,19,19,17.59,13.41,12,19,6.41Z"/></svg>`,
    };
    
    // --- Main App Logic ---
    function initializeMap() {
        if (map) { 
            setTimeout(() => { map.invalidateSize() }, 0);
            return; 
        }
        map = L.map('map').setView([40.730889, -73.284654], 12);
        setTimeout(() => {
            map.invalidateSize();
        }, 0);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        L.Control.geocoder({
            defaultMarkGeocode: true,
            placeholder: 'Search for address...',
        }).on('markgeocode', function(e) {
            const { center, name } = e.geocode;
            map.fitBounds(e.geocode.bbox);
            lastSearchResult = {
                address: name.split(',').slice(0, 2).join(','),
                lat: center.lat,
                lon: center.lng,
            };
            searchedAddressSpan.textContent = lastSearchResult.address;
            addFromSearchUI.style.display = 'block';
        }).addTo(map);
    }
    function getPopupContent(id, address, isMoving = false) {
        const moveLink = `<button title="Move Pin" class="icon-btn popup-link move-pin-btn" data-id="${id}">${icons.move}</button>`;
        const movingUI = `<div class="icon-actions">
                            <button title="Save Location" class="icon-btn popup-link save-location-popup-btn" data-id="${id}">${icons.save}</button>
                            <button title="Cancel Move" class="icon-btn popup-link cancel-move-popup-btn" data-id="${id}">${icons.cancel}</button>
                          </div>`;
        return `<strong>${id}</strong><br>${address}<hr style="margin: 4px 0;">${isMoving ? movingUI : moveLink}`;
    }
    async function getStations() {
      stationList.innerHTML = '';
      if (markers) { Object.values(markers).forEach(marker => map.removeLayer(marker)); }
      markers = {};
      const snapshot = await db.collection('pumpStations').orderBy('__name__').get();
      for (const doc of snapshot.docs) {
        const station = doc.data();
        const code = doc.id;
        const noteSnap = await db.collection('notes').doc(code).get();
        const noteText = noteSnap.exists ? noteSnap.data().text : '<span class="no-note">No note.</span>';
        const marker = L.marker([station.lat, station.lon], { draggable: false }).addTo(map);
        marker.bindPopup(getPopupContent(code, station.address));
        markers[code] = marker;
        marker.on('click', function() {
            document.querySelectorAll('#stationList li').forEach(item => item.classList.remove('selected'));
            const listItem = document.querySelector(`#stationList li[data-id="${code}"]`);
            if (listItem) {
                listItem.classList.add('selected');
                listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            map.flyTo(marker.getLatLng(), 18);
        });
        const li = document.createElement('li');
        li.dataset.id = code;
        li.innerHTML = `
          <div class="info-line">
            <div>
              <strong>${code}</strong> - <span class="address-text">${station.address}</span>
            </div>
            <div class="icon-actions">
              <button title="Edit Info" class="icon-btn edit-btn" data-id="${code}">${icons.edit}</button>
              <button title="Delete Station" class="icon-btn delete-btn" data-id="${code}">${icons.delete}</button>
            </div>
          </div>
          <div class="coords-line">
            Coords: <span id="lat-span-${code}">${station.lat.toFixed(5)}</span>, <span id="lon-span-${code}">${station.lon.toFixed(5)}</span>
          </div>
          <div class="note-section">
            <div class="note-header">
                <span>Note</span>
                <div class="icon-actions">
                    <button title="Edit Note" class="icon-btn edit-btn edit-note-btn" data-id="${code}">${icons.edit}</button>
                    <button title="Delete Note" class="icon-btn delete-btn delete-note-btn" data-id="${code}">${icons.delete}</button>
                </div>
            </div>
            <p class="note-text">${noteText}</p>
          </div>
        `;
        stationList.appendChild(li);
      }
    }
    addSearchedStationBtn.addEventListener('click', async () => {
        if (!lastSearchResult) return;
        const code = prompt("Please enter the unique code for this new station:", "S-");
        if (code) {
            await db.collection('pumpStations').doc(code.trim().toUpperCase()).set(lastSearchResult);
            addFromSearchUI.style.display = 'none';
            lastSearchResult = null;
            getStations();
        }
    });
    document.body.addEventListener('click', async (e) => {
        const btn = e.target.closest('.icon-btn');
        if (!btn) return;
        e.preventDefault();
        const id = btn.dataset.id;
        const marker = markers[id];
        if (btn.classList.contains('move-pin-btn')) {
            originalPinPositions[id] = marker.getLatLng();
            marker.dragging.enable();
            marker.getPopup().setContent(getPopupContent(id, marker.getPopup().getContent().split('<hr>')[0].split('<br>')[1], true));
        }
        if (btn.classList.contains('save-location-popup-btn')) {
            const newPos = marker.getLatLng();
            marker.dragging.disable();
            await db.collection('pumpStations').doc(id).update({ lat: newPos.lat, lon: newPos.lng });
            marker.closePopup();
            alert('Location updated!');
            await getStations();
        }
        if (btn.classList.contains('cancel-move-popup-btn')) {
            marker.dragging.disable();
            marker.setLatLng(originalPinPositions[id]);
            delete originalPinPositions[id];
            marker.closePopup();
        }
    });
    stationList.addEventListener('click', async (e) => {
      const li = e.target.closest('li');
      if (!li) return;
      const id = li.dataset.id;
      const btn = e.target.closest('.icon-btn');
      if (!btn) {
        document.querySelectorAll('#stationList li').forEach(item => item.classList.remove('selected'));
        li.classList.add('selected');
        const marker = markers[id];
        if (marker) {
          map.flyTo(marker.getLatLng(), 18);
          marker.openPopup();
        }
        return;
      }
      if (btn.classList.contains('edit-btn') && !btn.classList.contains('edit-note-btn')) {
        const currentAddress = li.querySelector('.address-text').textContent;
        const newAddress = prompt("Enter new address:", currentAddress);
        if (newAddress && newAddress !== currentAddress) {
          await db.collection('pumpStations').doc(id).update({ address: newAddress });
          alert('Address updated!');
          await getStations();
        }
      }
      if (btn.classList.contains('delete-btn') && !btn.classList.contains('delete-note-btn')) {
        if (confirm(`Are you sure you want to delete station ${id} and its note?`)) {
          await db.collection('pumpStations').doc(id).delete();
          await db.collection('notes').doc(id).delete().catch(()=>{});
          await getStations();
        }
      }
      if (btn.classList.contains('edit-note-btn')) {
        const noteDoc = await db.collection('notes').doc(id).get();
        const currentNote = noteDoc.exists ? noteDoc.data().text : "";
        const newNote = prompt("Enter note:", currentNote);
        if (newNote !== null) {
            await db.collection('notes').doc(id).set({ 
                text: newNote, 
                updated: firebase.firestore.FieldValue.serverTimestamp() 
            });
            alert('Note updated!');
            await getStations();
        }
      }
      if (btn.classList.contains('delete-note-btn')) {
          if (confirm('Are you sure you want to delete this note?')) {
              await db.collection('notes').doc(id).delete();
              alert('Note deleted!');
              await getStations();
          }
      }
    });
  </script>
</body>
</html>
