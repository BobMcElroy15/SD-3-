<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin - Sewer District 3 Pump Station Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    :root {
      --primary-color: #0066cc;
      --light-primary: #e7f3ff;
      --danger-color: #dc3545;
      --success-color: #28a745;
      --light-gray: #f8f9fa;
      --border-color: #dee2e6;
      --text-color: #212529;
      --muted-color: #6c757d;
    }

    /* Base & Layout */
    body { 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0; 
      background-color: var(--light-gray);
      overflow: hidden;
    }

    #app-layout { display: flex; height: 100vh; }
    #side-panel { width: 420px; background-color: #ffffff; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; box-shadow: 0 0 15px rgba(0,0,0,0.1); z-index: 10; }
    #map-container { flex-grow: 1; position: relative; }
    #map { height: 100%; width: 100%; }

    /* Header */
    #panel-header { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    #panel-header h1 { font-size: 1.25rem; margin: 0; color: var(--text-color); }
    #logoutBtn { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); font-weight: 500; border-radius: 5px; padding: 0.4rem 0.8rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
    #logoutBtn:hover { background-color: var(--danger-color); color: white; }

    /* Scrollable Content Area */
    #panel-content { overflow-y: auto; padding: 1rem; }
    #addFromSearch { display: none; background: var(--light-primary); padding: 15px; border-radius: 8px; margin-bottom: 1rem; }
    #addFromSearch p { margin: 0 0 10px 0; font-weight: 500; }
    #addFromSearch button { background: var(--success-color); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1rem; }

    /* Station List */
    #stationList { list-style-type: none; padding: 0; margin: 0; }
    #stationList li { background: #fff; margin-bottom: 0.75rem; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; transition: box-shadow 0.2s, border-color 0.2s; }
    #stationList li:hover { border-color: var(--primary-color); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    #stationList li.selected { border-color: var(--primary-color); background-color: var(--light-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    #stationList .info-line { font-weight: 500; margin-bottom: 0.5rem; }
    #stationList .coords-line { font-size: 0.85rem; color: var(--muted-color); }
    .station-actions { margin-top: 0.75rem; border-top: 1px solid var(--border-color); padding-top: 0.75rem; display: flex; gap: 0.5rem; }
    .station-actions button { flex-grow: 1; padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
    .edit-info-btn { background-color: var(--primary-color); }
    .delete-btn { background-color: var(--danger-color); }

    /* Note Section */
    .note-section { background: var(--light-gray); padding: 0.75rem; margin-top: 0.75rem; border-radius: 5px; }
    .note-text { font-style: italic; color: var(--muted-color); margin: 0 0 10px 0; word-wrap: break-word; }
    .note-text .no-note { color: #aaa; }
    .note-actions button { font-size: 0.8rem; padding: 4px 8px; flex-grow: 0; width: auto; background-color: #6c757d; }
    .note-actions .delete-note-btn { background-color: transparent; color: var(--muted-color); border: 1px solid var(--muted-color); }

    /* Auth Screen */
    #auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; background: #f8f9fa; }
    #auth-form { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 320px; }
  </style>
</head>
<body>

  <div id="auth-container">
    <div id="auth-form">
      <h2 id="form-title">Admin Sign In</h2>
      <input type="email" id="emailInput" placeholder="Email"><input type="password" id="passwordInput" placeholder="Password"><div id="auth-error"></div><button id="authBtn">Sign In</button><a id="switch-form">Need an account? Sign Up</a>
    </div>
  </div>

  <div id="app-layout" style="display: none;">
    <aside id="side-panel">
      <header id="panel-header">
        <h1>Pump Station Management</h1>
        <button id="logoutBtn">Sign Out</button>
      </header>
      <div id="panel-content">
        <div id="addFromSearch">
            <p><strong>Add new station:</strong> <span id="searchedAddress"></span></p>
            <button id="addSearchedStationBtn">Add Searched Location</button>
        </div>
        <h2>Existing Stations</h2>
        <ul id="stationList"></ul>
      </div>
    </aside>
    <main id="map-container">
      <div id="map"></div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Config & Init
    const firebaseConfig = {
      apiKey:            "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
      authDomain:        "sd3ps-map.firebaseapp.com",
      projectId:         "sd3ps-map",
      storageBucket:     "sd3ps-map.appspot.com",
      messagingSenderId: "14976888367",
      appId:             "1:14976888367:web:9ef05a76be1ca780d7e0da"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM & State Refs
    const authContainer = document.getElementById('auth-container');
    const appLayout = document.getElementById('app-layout');
    const logoutBtn = document.getElementById('logoutBtn');
    const stationList = document.getElementById('stationList');
    const addFromSearchUI = document.getElementById('addFromSearch');
    const searchedAddressSpan = document.getElementById('searchedAddress');
    const addSearchedStationBtn = document.getElementById('addSearchedStationBtn');
    
    let map;
    let markers = {};
    let lastSearchResult = null;
    let originalPinPositions = {};

    // --- Authentication Logic ---
    const authForm = document.getElementById('auth-form');
    const formTitle = document.getElementById('form-title');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const authBtn = document.getElementById('authBtn');
    const switchFormLink = document.getElementById('switch-form');
    const authError = document.getElementById('auth-error');
    let isSignUp = false;
    switchFormLink.addEventListener('click', () => {
        isSignUp = !isSignUp;
        formTitle.textContent = isSignUp ? 'Create Account' : 'Admin Sign In';
        authBtn.textContent = isSignUp ? 'Sign Up' : 'Sign In';
        switchFormLink.textContent = isSignUp ? 'Have an account? Sign In' : 'Need an account? Sign Up';
        authError.textContent = '';
    });
    authBtn.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        authError.textContent = '';
        const authAction = isSignUp ? auth.createUserWithEmailAndPassword(email, password) : auth.signInWithEmailAndPassword(email, password);
        authAction.catch(error => { authError.textContent = error.message; });
    });
    logoutBtn.addEventListener('click', () => auth.signOut());
    auth.onAuthStateChanged(user => {
      if (user) {
        authContainer.style.display = 'none';
        appLayout.style.display = 'flex';
        initializeMap();
        getStations();
      } else {
        authContainer.style.display = 'flex';
        appLayout.style.display = 'none';
        if(map) { map.remove(); map = null; }
      }
    });

    // --- Main App Logic (Map and Stations) ---
    function initializeMap() {
        if (map) return;
        map = L.map('map').setView([40.730889, -73.284654], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        L.Control.geocoder({
            defaultMarkGeocode: true,
            placeholder: 'Search for address...',
        }).on('markgeocode', function(e) {
            const { center, name } = e.geocode;
            map.fitBounds(e.geocode.bbox);
            lastSearchResult = {
                address: name.split(',').slice(0, 2).join(','),
                lat: center.lat,
                lon: center.lng,
            };
            searchedAddressSpan.textContent = lastSearchResult.address;
            addFromSearchUI.style.display = 'block';
        }).addTo(map);
    }

    function getPopupContent(id, address, isMoving = false) {
        const moveLink = `<a class="popup-link move-pin-btn" data-id="${id}">Move Pin</a>`;
        const movingUI = `PIN UNLOCKED<br>
                          <a class="popup-link save-location-popup-btn" data-id="${id}">Save Location</a> | 
                          <a class="popup-link cancel-move-popup-btn" data-id="${id}">Cancel</a>`;
        return `<strong>${id}</strong><br>${address}<hr style="margin: 4px 0;">${isMoving ? movingUI : moveLink}`;
    }
    
    async function getStations() {
      stationList.innerHTML = '';
      if (markers) {
        Object.values(markers).forEach(marker => map.removeLayer(marker));
      }
      markers = {};
      const snapshot = await db.collection('pumpStations').orderBy('__name__').get();
      
      for (const doc of snapshot.docs) {
        const station = doc.data();
        const code = doc.id;

        // Fetch the note for this station
        const noteSnap = await db.collection('notes').doc(code).get();
        const noteText = noteSnap.exists ? noteSnap.data().text : '<span class="no-note">No note.</span>';
        
        const marker = L.marker([station.lat, station.lon], { draggable: false }).addTo(map);
        marker.bindPopup(getPopupContent(code, station.address));
        markers[code] = marker;

        marker.on('click', function() {
            document.querySelectorAll('#stationList li').forEach(item => item.classList.remove('selected'));
            const listItem = document.querySelector(`#stationList li[data-id="${code}"]`);
            if (listItem) {
                listItem.classList.add('selected');
                listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            map.flyTo(marker.getLatLng(), 18);
        });

        const li = document.createElement('li');
        li.dataset.id = code;
        li.innerHTML = `
          <div class="info-line">
            <strong>${code}</strong> - <span class="address-text">${station.address}</span>
          </div>
          <div class="coords-line">
            Coords: <span id="lat-span-${code}">${station.lat.toFixed(5)}</span>, <span id="lon-span-${code}">${station.lon.toFixed(5)}</span>
          </div>
          <div class="station-actions">
            <button class="edit-info-btn" data-id="${code}">Edit Info</button>
            <button class="delete-btn" data-id="${code}">Delete Station</button>
          </div>
          <div class="note-section">
            <p class="note-text">${noteText}</p>
            <div class="note-actions">
                <button class="edit-note-btn" data-id="${code}">Edit Note</button>
                <button class="delete-note-btn" data-id="${code}">Delete Note</button>
            </div>
          </div>
        `;
        stationList.appendChild(li);
      }
    }

    addSearchedStationBtn.addEventListener('click', async () => {
        if (!lastSearchResult) return;
        const code = prompt("Please enter the unique code for this new station:", "S-");
        if (code) {
            await db.collection('pumpStations').doc(code.trim().toUpperCase()).set(lastSearchResult);
            addFromSearchUI.style.display = 'none';
            lastSearchResult = null;
            getStations();
        }
    });

    document.body.addEventListener('click', async (e) => {
        const target = e.target;
        if (target.matches('.move-pin-btn')) {
            e.preventDefault();
            const id = target.dataset.id;
            const marker = markers[id];
            originalPinPositions[id] = marker.getLatLng();
            marker.dragging.enable();
            marker.getPopup().setContent(getPopupContent(id, marker.getPopup().getContent().split('<hr>')[0].split('<br>')[1], true));
        }
        if (target.matches('.save-location-popup-btn')) {
            e.preventDefault();
            const id = target.dataset.id;
            const marker = markers[id];
            const newPos = marker.getLatLng();
            marker.dragging.disable();
            await db.collection('pumpStations').doc(id).update({ lat: newPos.lat, lon: newPos.lng });
            marker.closePopup();
            alert('Location updated!');
            await getStations();
        }
        if (target.matches('.cancel-move-popup-btn')) {
            e.preventDefault();
            const id = target.dataset.id;
            const marker = markers[id];
            marker.dragging.disable();
            marker.setLatLng(originalPinPositions[id]);
            delete originalPinPositions[id];
            marker.closePopup();
        }
    });

    stationList.addEventListener('click', async (e) => {
      const li = e.target.closest('li');
      if (!li) return;
      const id = li.dataset.id;
      
      if (!e.target.closest('.station-actions') && !e.target.closest('.note-section')) {
        document.querySelectorAll('#stationList li').forEach(item => item.classList.remove('selected'));
        li.classList.add('selected');
        const marker = markers[id];
        if (marker) {
          map.flyTo(marker.getLatLng(), 18);
          marker.openPopup();
        }
      }

      if (e.target.matches('.edit-info-btn')) {
        const currentAddress = li.querySelector('.address-text').textContent;
        const newAddress = prompt("Enter new address:", currentAddress);
        if (newAddress && newAddress !== currentAddress) {
          await db.collection('pumpStations').doc(id).update({ address: newAddress });
          alert('Address updated!');
          await getStations();
        }
      }
      
      if (e.target.matches('.delete-btn')) {
        if (confirm(`Are you sure you want to delete station ${id} and its note?`)) {
          await db.collection('pumpStations').doc(id).delete();
          await db.collection('notes').doc(id).delete();
          await getStations();
        }
      }
      
      if (e.target.matches('.edit-note-btn')) {
        const noteDoc = await db.collection('notes').doc(id).get();
        const currentNote = noteDoc.exists ? noteDoc.data().text : "";
        const newNote = prompt("Enter note:", currentNote);
        if (newNote !== null) { // Allow saving an empty note
            await db.collection('notes').doc(id).set({ 
                text: newNote, 
                updated: firebase.firestore.FieldValue.serverTimestamp() 
            });
            alert('Note updated!');
            await getStations();
        }
      }
      
      if (e.target.matches('.delete-note-btn')) {
          if (confirm('Are you sure you want to delete this note?')) {
              await db.collection('notes').doc(id).delete();
              alert('Note deleted!');
              await getStations();
          }
      }
    });
  </script>
</body>
</html>
