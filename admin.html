<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pump Stations Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Firebase & Leaflet & Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <style>
    body { margin:0; padding:0; font-family:sans-serif; }
    h1 { margin:10px; }
    #map { height:55vh; }
    #stationsTable { height:45vh; overflow-y:auto; }
    #stationsTable table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ccc; padding:6px; }
    th { background:#f5f5f5; }
    tr:hover, tr.highlight { background:#d0eaff !important; }
    input[readonly] { background: #f5f5f5; border: none; }
    button { margin:0 4px; }
    #loginDiv { display: flex; flex-direction: column; gap: 7px; align-items: flex-start; margin: 30px 20px; }
    #logoutBtn { margin: 10px 20px; }
    .actions button { min-width: 60px; }
  </style>
</head>
<body>
  <!-- Login form -->
  <div id="loginDiv" style="display:none">
    <h2>Admin Login</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Sign In</button>
    <div id="loginMsg" style="color:red"></div>
  </div>

  <div id="adminUI" style="display:none">
    <button id="logoutBtn">Sign Out</button>
    <h1>Pump Stations Admin</h1>
    <div id="map"></div>
    <div id="stationsTable">
      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Address</th>
            <th>Lat</th>
            <th>Lon</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
  // ==== Firebase Config & Init ====
  firebase.initializeApp({
    apiKey:            "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
    authDomain:        "sd3ps-map.firebaseapp.com",
    projectId:         "sd3ps-map",
    storageBucket:     "sd3ps-map.appspot.com",
    messagingSenderId: "14976888367",
    appId:             "1:14976888367:web:9ef05a76be1ca780d7e0da",
    measurementId:     "G-HHX1X8KFSF"
  });
  const auth = firebase.auth();
  const db   = firebase.firestore();
  // =====

  // === Auth UI Logic ===
  const loginDiv  = document.getElementById('loginDiv');
  const adminUI   = document.getElementById('adminUI');
  const loginMsg  = document.getElementById('loginMsg');
  const loginBtn  = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  loginBtn.onclick = async function() {
    loginMsg.textContent = '';
    try {
      await auth.signInWithEmailAndPassword(
        document.getElementById('email').value,
        document.getElementById('password').value
      );
    } catch(e) {
      loginMsg.textContent = e.message;
    }
  };
  logoutBtn.onclick = function() { auth.signOut(); };

  // Show/hide UI depending on login state
  auth.onAuthStateChanged(user => {
    if (user) {
      loginDiv.style.display = 'none';
      adminUI.style.display  = '';
      loadAdminUI();
    } else {
      adminUI.style.display  = 'none';
      loginDiv.style.display = '';
    }
  });

  // ==== Main Admin UI Logic ====
  let markers = [], docs = [];
  function loadAdminUI() {
    // Clear map/table
    document.querySelector('#stationsTable tbody').innerHTML = '';
    if (window.map) window.map.remove();

    // --- Map + Geocoder
    window.map = L.map('map').setView([40.730889, -73.284654], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap contributors' }).addTo(map);
    L.Control.geocoder({ placeholder: 'Search address…' })
      .on('markgeocode', e => map.setView(e.geocode.center, 17))
      .addTo(map);

    markers = []; docs = [];
    const tbody = document.querySelector('#stationsTable tbody');

    // --- Add one station row + marker
    function addStation(doc, idx) {
      const code = doc.id;
      let { address, lat, lon } = doc.data();
      docs[idx] = doc;

      // Table row
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="code"  value="${code}" readonly></td>
        <td><input class="addr"  value="${address}" readonly></td>
        <td><input class="lat"   type="number" step="any" value="${lat}" readonly></td>
        <td><input class="lon"   type="number" step="any" value="${lon}" readonly></td>
        <td class="actions">
          <button class="edit"  data-idx="${idx}">Edit</button>
          <button class="save"  data-idx="${idx}" style="display:none;">Save</button>
          <button class="cancel"data-idx="${idx}" style="display:none;">Cancel</button>
          <button class="del"   data-idx="${idx}">Delete</button>
        </td>`;
      tbody.appendChild(tr);

      // Row click: highlight & show marker popup
      tr.onclick = e => {
        markers.forEach(mk => mk.setZIndexOffset(0));
        markers[idx].setZIndexOffset(1000);
        markers[idx].fire('click');
        document.querySelectorAll('tr').forEach(r=>r.classList.remove('highlight'));
        tr.classList.add('highlight');
        tr.scrollIntoView({behavior:'smooth',block:'nearest'});
      };

      // Map marker
      const m = L.marker([lat, lon]).addTo(map);
      markers[idx] = m;
      m.on('click', async () => {
        // Popup content
        const ns = await db.collection('notes').doc(code).get();
        const note = ns.exists ? ns.data().text : '';
        const popup = `
          <strong>${code}</strong><br>
          ${address}<br>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}"
             target="_blank">Navigate</a>
          | <a href="#" class="note-btn" data-idx="${idx}">Add/Edit Note</a>
          | <a href="#" class="del-note" data-idx="${idx}">Delete Note</a>
          | <a href="#" class="undo-note" data-idx="${idx}" style="display:none">Undo</a>
          | <a href="#" class="adjust-pin" data-idx="${idx}">Adjust Pin</a>
          <br>
          <div id="note-display-${idx}" style="font-style:italic;color:#555">
            ${note}
          </div>`;
        map.once('moveend', ()=> m.bindPopup(popup).openPopup());
        map.setView([lat, lon],17,{animate:true,duration:0.8});
        // Highlight table
        document.querySelectorAll('tr').forEach(r=>r.classList.remove('highlight'));
        tr.classList.add('highlight');
        tr.scrollIntoView({behavior:'smooth',block:'nearest'});
      });
    }

    // --- Load all stations
    db.collection('pumpStations').get().then(snap=>{
      snap.docs.forEach((doc,i)=> addStation(doc,i));
    });

    // --- Table Edit/Save/Cancel/Delete
    tbody.onclick = async e => {
      const idx = +e.target.dataset.idx;
      const tr  = tbody.children[idx];
      const code= tr.querySelector('.code').value;
      if (e.target.matches('.edit')) {
        tr.querySelectorAll('input').forEach(input => { if (input.className !== 'code') input.readOnly = false; });
        tr.querySelector('.edit').style.display   = 'none';
        tr.querySelector('.save').style.display   = '';
        tr.querySelector('.cancel').style.display = '';
      }
      if (e.target.matches('.cancel')) location.reload();
      if (e.target.matches('.save')) {
        const newAddress = tr.querySelector('.addr').value.trim();
        const newLat     = parseFloat(tr.querySelector('.lat').value);
        const newLon     = parseFloat(tr.querySelector('.lon').value);
        await db.collection('pumpStations').doc(code).update({
          address:newAddress, lat:newLat, lon:newLon
        });
        alert('Saved');
        location.reload();
      }
      if (e.target.matches('.del')) {
        if (!confirm(`Delete ${code}?`)) return;
        await db.collection('pumpStations').doc(code).delete();
        alert('Deleted');
        location.reload();
      }
    };

    // --- Popup note & adjust-pin
    document.body.onclick = async e => {
      if (!e.target.dataset.idx) return;
      const idx = +e.target.dataset.idx;
      const code = docs[idx].id;
      // Add/Edit note
      if (e.target.matches('.note-btn')){
        e.preventDefault();
        const cur = (await db.collection('notes').doc(code).get()).data()?.text||'';
        const txt = prompt(`Note for ${code}:`,cur);
        if (txt!==null){
          await db.collection('notes').doc(code)
            .set({ text:txt, updated:firebase.firestore.FieldValue.serverTimestamp() });
          document.getElementById(`note-display-${idx}`).textContent=txt;
        }
      }
      // Delete note
      if (e.target.matches('.del-note')){
        e.preventDefault();
        const snapN = await db.collection('notes').doc(code).get();
        window.tempDel = window.tempDel || {};
        window.tempDel[code] = snapN.exists? snapN.data().text:'';
        await db.collection('notes').doc(code).delete();
        document.getElementById(`note-display-${idx}`).textContent='';
        e.target.nextElementSibling.style.display='inline';
      }
      // Undo note
      if (e.target.matches('.undo-note')){
        e.preventDefault();
        await db.collection('notes').doc(code)
          .set({ text:window.tempDel[code], updated:firebase.firestore.FieldValue.serverTimestamp() });
        document.getElementById(`note-display-${idx}`).textContent=window.tempDel[code];
        e.target.style.display='none';
        delete window.tempDel[code];
      }
      // Adjust Pin
      if (e.target.matches('.adjust-pin')){
        e.preventDefault();
        const m = markers[idx];
        if (!m.dragging.enabled()){
          m.dragging.enable();
          e.target.textContent='Save Pin';
        } else {
          m.dragging.disable();
          const {lat,lng} = m.getLatLng();
          await db.collection('pumpStations').doc(code)
            .update({ lat, lon:lng });
          alert('Pin moved');
          location.reload();
        }
      }
    };
  }
  </script>
</body>
</html>
