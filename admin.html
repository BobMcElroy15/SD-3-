<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pump Stations Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Leaflet & Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <style>
    body { margin:0; padding:0; font-family:sans-serif; }
    #map { height:60vh; }
    #tableWrapper { height:40vh; overflow:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ccc; padding:6px; text-align:left; }
    th { background:#f5f5f5; }
    tr:hover, tr.selected { background:#e6f7ff; }
    input { width:100%; box-sizing:border-box; border:1px solid transparent; background:transparent; }
    input.editing { border-color:#0066cc; background:#fff; }
    button { margin:0 4px; }
    #geocoder { position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1001; }
  </style>
</head>
<body>
  <script>
    // simple password gate
    const pwd = prompt("Enter admin password:");
    if (pwd !== "YOUR_SECRET") {
      alert("Wrong password"); 
      window.location = "/";
    }
  </script>

  <h1 style="margin:10px">Pump Stations Admin</h1>
  <div id="map"></div>
  <div id="tableWrapper">
    <table>
      <thead>
        <tr><th>Code</th><th>Address</th><th>Lat</th><th>Lon</th><th>Actions</th></tr>
      </thead>
      <tbody id="stationsBody"></tbody>
    </table>
  </div>

  <!-- Leaflet & Geocoder & Firebase SDKs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <script>
  (async function(){
    // Firebase init
    firebase.initializeApp({
      apiKey: "...", authDomain:"sd3ps-map.firebaseapp.com",
      projectId:"sd3ps-map", storageBucket:"sd3ps-map.appspot.com",
      messagingSenderId:"14976888367", appId:"1:14976888367:web:...", 
      measurementId:"G-..."
    });
    const analytics = firebase.analytics();
    const db = firebase.firestore();

    // Map + geocoder
    const map = L.map('map').setView([40.73, -73.28], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OSM'
    }).addTo(map);
    L.Control.geocoder({ placeholder:'Search address…' })
      .on('markgeocode', e => map.setView(e.geocode.center,17))
      .addTo(map)
      .getContainer().id = 'geocoder';

    // data holders
    const markers = [], docs = [];
    const tbody = document.getElementById('stationsBody');

    // render one station
    function renderRow(doc,i){
      const {address,lat,lon} = doc.data(), code=doc.id;
      docs[i] = doc;
      // table row + inputs
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="fld code" value="${code}" disabled></td>
        <td><input class="fld addr" value="${address}" disabled></td>
        <td><input class="fld lat"  type="number" step="any" value="${lat}" disabled></td>
        <td><input class="fld lon"  type="number" step="any" value="${lon}" disabled></td>
        <td>
          <button class="edit" data-i="${i}">Edit</button>
          <button class="save" data-i="${i}" style="display:none">Save</button>
          <button class="cancel" data-i="${i}" style="display:none">Cancel</button>
          <button class="del" data-i="${i}">Delete</button>
        </td>`;
      tbody.appendChild(tr);

      // marker
      const m = L.marker([lat,lon]).addTo(map);
      markers[i]=m;
      m.on('click',()=> openPopup(i, code, address, lat, lon, tr, m));

      // row click → popup
      tr.addEventListener('click',()=> markers[i].fire('click'));
    }

    // build table + markers
    const snap = await db.collection('pumpStations').get();
    snap.docs.forEach((doc,i)=>renderRow(doc,i));

    // popup builder
    async function openPopup(i,code,address,lat,lon,tr,m){
      // highlight row
      document.querySelectorAll('tr').forEach(r=>r.classList.remove('selected'));
      tr.classList.add('selected');
      // fetch note
      const ns = await db.collection('notes').doc(code).get();
      const note = ns.exists?ns.data().text:'';
      const html = `
        <strong>${code}</strong><br>${address}<br>
        <a href="https://maps.google.com/?q=${lat},${lon}" target="_blank">Navigate</a>
        | <a href="#" class="note-btn" data-i="${i}">Add/Edit Note</a>
        | <a href="#" class="adjust" data-i="${i}">Adjust Pin</a>
        <br><div id="note-display-${i}" style="margin-top:6px;font-style:italic;">${note}</div>
      `;
      map.once('moveend',()=>m.bindPopup(html).openPopup());
      map.setView([lat,lon],17,{animate:true,duration:0.5});
    }

    // table controls
    tbody.addEventListener('click', async e=>{
      const i = +e.target.dataset.i;
      const tr = tbody.children[i];
      const code = tr.querySelector('.code').value;

      // Edit
      if(e.target.matches('.edit')){
        tr.querySelectorAll('.fld').forEach(f=>f.disabled=false,f.classList.add('editing'));
        tr.querySelector('.edit').style.display='none';
        tr.querySelector('.save, .cancel').forEach(b=>b.style.display='inline');
      }
      // Cancel
      if(e.target.matches('.cancel')){
        const doc = docs[i].data();
        tr.querySelector('.addr').value = doc.address;
        tr.querySelector('.lat' ).value = doc.lat;
        tr.querySelector('.lon' ).value = doc.lon;
        tr.querySelectorAll('.fld').forEach(f=>f.disabled=true,f.classList.remove('editing'));
        tr.querySelector('.edit').style.display='inline';
        tr.querySelector('.save, .cancel').forEach(b=>b.style.display='none');
      }
      // Save
      if(e.target.matches('.save')){
        const newAddr = tr.querySelector('.addr').value;
        const newLat  = parseFloat(tr.querySelector('.lat').value);
        const newLon  = parseFloat(tr.querySelector('.lon').value);
        await db.collection('pumpStations').doc(code)
          .update({address:newAddr,lat:newLat,lon:newLon});
        // update marker
        markers[i].setLatLng([newLat,newLon]);
        alert('Saved');
        // reset inputs
        tr.querySelectorAll('.fld').forEach(f=>f.disabled=true,f.classList.remove('editing'));
        tr.querySelector('.edit').style.display='inline';
        tr.querySelector('.save, .cancel').forEach(b=>b.style.display='none');
      }
      // Delete
      if(e.target.matches('.del')){
        if(!confirm(`Delete ${code}?`)) return;
        await db.collection('pumpStations').doc(code).delete();
        alert('Deleted');
        location.reload();
      }
    });

    // popup note + adjust-pin
    document.body.addEventListener('click', async e=>{
      const i = +e.target.dataset.i;
      if(isNaN(i)) return;

      // note
      if(e.target.matches('.note-btn')){
        e.preventDefault();
        const code = docs[i].id;
        const cur  = (await db.collection('notes').doc(code).get()).data()?.text||'';
        const txt  = prompt(`Note for ${code}:`,cur);
        if(txt!==null){
          await db.collection('notes').doc(code)
            .set({text:txt,updated:firebase.firestore.FieldValue.serverTimestamp()});
          document.getElementById(`note-display-${i}`).textContent=txt;
        }
      }

      // adjust-pin
      if(e.target.matches('.adjust')){
        e.preventDefault();
        const m = markers[i];
        if(!m.dragging.enabled()){
          m.dragging.enable();
          e.target.textContent='Save Pin';
        } else {
          m.dragging.disable();
          const {lat,lng} = m.getLatLng();
          const code = docs[i].id;
          await db.collection('pumpStations').doc(code)
            .update({lat,lon:lng});
          alert('Pin moved');
        }
      }
    });

  })();
  </script>
</body>
</html>
