<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pump Stations Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Leaflet & Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

  <style>
    body { margin:0; padding:0; font-family:sans-serif; }
    #login, #admin { display:none; }
    #login { padding:20px; }
    #map { height:40vh; }
    #stationsTable { height:60vh; overflow-y:auto; }
    #stationsTable table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ccc; padding:6px; text-align:left; }
    th { background:#f5f5f5; }
    tr:hover { background:#fafafa; cursor:pointer; }
    tr.selected { background:#d0eaff; }
    button { margin:0 4px; }
    input { box-sizing:border-box; padding:4px; width:100%; }
    #logout { position:absolute; top:10px; right:10px; }
  </style>
</head>
<body>

  <!-- LOGIN FORM -->
  <div id="login">
    <h2>Admin Login</h2>
    <input id="email"    type="email"    placeholder="Email"    /><br><br>
    <input id="password" type="password" placeholder="Password" /><br><br>
    <button id="btnLogin">Log In</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- ADMIN INTERFACE -->
  <div id="admin">
    <button id="logout">Log Out</button>
    <h1 style="margin:10px">Pump Stations Admin</h1>
    <div id="map"></div>
    <div id="stationsTable">
      <table>
        <thead>
          <tr><th>Code</th><th>Address</th><th>Lat</th><th>Lon</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- SDKs: Firebase App, Auth, Firestore, Analytics; Leaflet/Geocoder -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
  (async function(){
    // ─── Firebase init ────────────────────────────────────────────────
    firebase.initializeApp({
      apiKey:            "AIzaSyBC4ytQPxzKZd1L47Gc5M4FoRYn44C5q9w",
      authDomain:        "sd3ps-map.firebaseapp.com",
      projectId:         "sd3ps-map",
      storageBucket:     "sd3ps-map.appspot.com",
      messagingSenderId: "14976888367",
      appId:             "1:14976888367:web:9ef05a76be1ca780d7e0da",
      measurementId:     "G-HHX1X8KFSF"
    });
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const col  = db.collection('pumpStations');
    const analytics = firebase.analytics();

    const loginDiv = document.getElementById('login');
    const adminDiv = document.getElementById('admin');
    const emailIn  = document.getElementById('email');
    const passIn   = document.getElementById('password');
    const errP     = document.getElementById('loginError');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout= document.getElementById('logout');

    // ─── Auth state observer ──────────────────────────────────────────
    auth.onAuthStateChanged(user=>{
      if(user){
        loginDiv.style.display = 'none';
        adminDiv.style.display = 'block';
        initAdmin();
      } else {
        loginDiv.style.display = 'block';
        adminDiv.style.display = 'none';
      }
    });

    // ─── Login handler ───────────────────────────────────────────────
    btnLogin.onclick = async ()=>{
      errP.textContent = '';
      try {
        await auth.signInWithEmailAndPassword(emailIn.value, passIn.value);
      } catch(err) {
        errP.textContent = err.message;
      }
    };
    btnLogout.onclick = ()=> auth.signOut();

    // ─── Build admin UI only after login ─────────────────────────────
    let initialized = false;
    async function initAdmin(){
      if(initialized) return;
      initialized = true;

      // Map + search
      const map = L.map('map').setView([40.730889, -73.284654], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'© OpenStreetMap contributors'
      }).addTo(map);
      L.Control.geocoder({ placeholder: 'Search address…' })
        .on('markgeocode', e=> map.setView(e.geocode.center,17))
        .addTo(map);

      // Data holders
      const markers = [], docs = [], tempDel = {};
      const tbody = document.querySelector('#stationsTable tbody');

      function highlightRow(i){
        Array.from(tbody.children).forEach((tr,j)=>{
          tr.classList.toggle('selected', i===j);
        });
      }

      // Render one row + marker
      async function addStation(doc,i){
        const code = doc.id;
        const {address,lat,lon} = doc.data();
        docs[i]=doc;

        // Row
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${code}</td>
          <td>${address}</td>
          <td>${lat}</td>
          <td>${lon}</td>
          <td>
            <button class="edit-btn" data-idx="${i}">Edit</button>
            <button class="del-btn"  data-idx="${i}">Delete</button>
          </td>`;
        tbody.appendChild(tr);
        tr.addEventListener('click', ()=> {
          markers[i].fire('click');
          highlightRow(i);
        });

        // Marker
        const m=L.marker([lat,lon]).addTo(map);
        markers[i]=m;
        m.on('click',async()=>{
          const noteSnap = await db.collection('notes').doc(code).get();
          const note = noteSnap.exists? noteSnap.data().text : '';
          const html=`
            <strong>${code}</strong><br>
            ${address}<br>
            <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank">Navigate</a>
            | <a href="#" class="note-btn" data-idx="${i}">Add/Edit Note</a>
            | <a href="#" class="del-note" data-idx="${i}">Delete Note</a>
            | <a href="#" class="undo-note" data-idx="${i}" style="display:none">Undo</a>
            | <a href="#" class="adjust-pin" data-idx="${i}">Adjust Pin</a>
            <br>
            <div id="note-display-${i}" style="font-style:italic;color:#555">${note}</div>`;
          map.once('moveend',()=>m.bindPopup(html).openPopup());
          map.setView([lat,lon],17,{animate:true,duration:0.8});
          highlightRow(i);
        });
      }

      // Load & render all
      const snap = await col.get();
      snap.docs.forEach((doc,i)=> addStation(doc,i));

      // Table: Edit / Delete
      tbody.addEventListener('click',async e=>{
        const i=+e.target.dataset.idx;
        if(e.target.matches('.edit-btn')){
          const tr=tbody.children[i];
          const code=tr.children[0].textContent;
          const addr=prompt('New address:',tr.children[1].textContent)        ||tr.children[1].textContent;
          const lat =parseFloat(prompt('New lat:',tr.children[2].textContent))||tr.children[2].textContent;
          const lon =parseFloat(prompt('New lon:',tr.children[3].textContent))||tr.children[3].textContent;
          await col.doc(code).update({address:addr,lat,lon});
          alert('Saved');
          location.reload();
        }
        if(e.target.matches('.del-btn')){
          const code=tbody.children[i].children[0].textContent;
          if(confirm(`Delete ${code}?`)){
            await col.doc(code).delete();
            alert('Deleted');
            location.reload();
          }
        }
      });

      // Popup: notes & adjust-pin
      document.body.addEventListener('click',async e=>{
        const idx=+e.target.dataset.idx;
        if(isNaN(idx)) return;
        const code=docs[idx].id;

        if(e.target.matches('.note-btn')){
          e.preventDefault();
          const cur=(await db.collection('notes').doc(code).get()).data()?.text||'';
          const txt=prompt(`Note for ${code}:`,cur);
          if(txt!==null){
            await db.collection('notes').doc(code).set({
              text:txt,updated:firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById(`note-display-${idx}`).textContent=txt;
          }
        }
        if(e.target.matches('.del-note')){
          e.preventDefault();
          const snapN=await db.collection('notes').doc(code).get();
          tempDel[code]=snapN.exists? snapN.data().text : '';
          await db.collection('notes').doc(code).delete();
          document.getElementById(`note-display-${idx}`).textContent='';
          e.target.nextElementSibling.style.display='inline';
        }
        if(e.target.matches('.undo-note')){
          e.preventDefault();
          await db.collection('notes').doc(code).set({
            text:tempDel[code],updated:firebase.firestore.FieldValue.serverTimestamp()
          });
          document.getElementById(`note-display-${idx}`).textContent=tempDel[code];
          e.target.style.display='none';
          delete tempDel[code];
        }
        if(e.target.matches('.adjust-pin')){
          e.preventDefault();
          const m=markers[idx];
          if(!m.dragging.enabled()){
            m.dragging.enable();
            e.target.textContent='Save Pin';
          } else {
            m.dragging.disable();
            const {lat,lng}=m.getLatLng();
            await col.doc(code).update({lat,lon:lng});
            alert('Pin moved');
            location.reload();
          }
        }
      });
    }
  })();
  </script>
</body>
</html>
